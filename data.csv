question,sql_query,data_preview
What is the total sales for last quarter?,"WITH max_date AS (
  SELECT MAX(date) AS latest_date FROM dim_calendar
),
last_q AS (
  SELECT
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN EXTRACT(YEAR FROM latest_date) - 1
      ELSE EXTRACT(YEAR FROM latest_date)
    END AS target_year,
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN 4
      ELSE EXTRACT(QUARTER FROM latest_date) - 1
    END AS target_quarter
  FROM max_date
)
SELECT
  lq.target_year,
  lq.target_quarter,
  SUM(s.order_quantity * p.product_price) AS revenue_last_quarter
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
JOIN dim_calendar c ON s.order_date = c.date
CROSS JOIN last_q lq
WHERE c.year = lq.target_year
  AND c.quarter = lq.target_quarter
GROUP BY
  lq.target_year,
  lq.target_quarter;","{""target_year"":{""0"":2022.0},""target_quarter"":{""0"":1.0},""revenue_last_quarter"":{""0"":4062216.0833000001}}"
Which customer segments are most profitable over the last 12 months?Which products have the highest profit margin?Which customer segments are most profitable?What are our best-selling products?,"WITH max_cal_date AS (
    SELECT MAX(date) AS latest_date FROM dim_calendar
),
customer_profit_overall AS (
    SELECT
        'Customer Profitability' AS analysis_category,
        dc.demographics AS analysis_segment,
        'Overall' AS analysis_period,
        NULL::TEXT AS analysis_item_name,
        'Total Profit' AS metric_name,
        SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS metric_value
    FROM fact_sales fs
    JOIN dim_products dp ON fs.product_key = dp.product_key
    JOIN dim_customers dc ON fs.customer_key = dc.customer_key
    GROUP BY dc.demographics
),
customer_profit_last_12_months AS (
    SELECT
        'Customer Profitability' AS analysis_category,
        dc.demographics AS analysis_segment,
        'Last 12 Months' AS analysis_period,
        NULL::TEXT AS analysis_item_name,
        'Total Profit' AS metric_name,
        SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS metric_value
    FROM fact_sales fs
    JOIN dim_products dp ON fs.product_key = dp.product_key
    JOIN dim_customers dc ON fs.customer_key = dc.customer_key
    JOIN dim_calendar dcal ON fs.order_date = dcal.date
    CROSS JOIN max_cal_date mcd
    WHERE dcal.date >= (mcd.latest_date - INTERVAL '12 months')
    GROUP BY dc.demographics
),
product_profit_margins AS (
    SELECT
        'Product Performance' AS analysis_category,
        NULL::TEXT AS analysis_segment,
        'Overall' AS analysis_period,
        dp.product_name AS analysis_item_name,
        'Profit Margin Percentage' AS metric_name,
        CASE WHEN dp.product_price > 0 THEN (dp.product_price - dp.product_cost) / dp.product_price ELSE 0 END AS metric_value
    FROM dim_products dp
),
best_selling_products AS (
    SELECT
        'Product Performance' AS analysis_category,
        NULL::TEXT AS analysis_segment,
        'Overall' AS analysis_period,
        dp.product_name AS analysis_item_name,
        'Total Quantity Sold' AS metric_name,
        SUM(fs.order_quantity) AS metric_value
    FROM fact_sales fs
    JOIN dim_products dp ON fs.product_key = dp.product_key
    GROUP BY dp.product_name
)
SELECT * FROM customer_profit_overall
UNION ALL
SELECT * FROM customer_profit_last_12_months
UNION ALL
SELECT * FROM product_profit_margins
UNION ALL
SELECT * FROM best_selling_products
ORDER BY analysis_category, analysis_segment, analysis_item_name, metric_name;",{}
What is the total sales for last quarter?,"WITH max_date AS (
  SELECT MAX(date) AS latest_date FROM dim_calendar
),
last_q AS (
  SELECT
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN EXTRACT(YEAR FROM latest_date) - 1
      ELSE EXTRACT(YEAR FROM latest_date)
    END AS target_year,
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN 4
      ELSE EXTRACT(QUARTER FROM latest_date) - 1
    END AS target_quarter
  FROM max_date
)
SELECT
  lq.target_year,
  lq.target_quarter,
  SUM(s.order_quantity * p.product_price) AS revenue_last_quarter
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
JOIN dim_calendar c ON s.order_date = c.date
CROSS JOIN last_q lq
WHERE c.year = lq.target_year
  AND c.quarter = lq.target_quarter
GROUP BY
  lq.target_year,
  lq.target_quarter;","{""target_year"":{""0"":2022.0},""target_quarter"":{""0"":1.0},""revenue_last_quarter"":{""0"":4062216.0833000001}}"
Which customer segments are most profitable over the last 12 months?,/* unable to generate SQL */,{}
Which products have the highest profit margin?,"SELECT p.product_name, SUM(s.order_quantity * (p.product_price - p.product_cost)) AS total_profit, SUM(s.order_quantity * p.product_price) AS total_revenue, (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 100.0) / NULLIF(SUM(s.order_quantity * p.product_price), 0) AS profit_margin_percentage FROM fact_sales s JOIN dim_products p ON s.product_key = p.product_key GROUP BY p.product_key, p.product_name ORDER BY profit_margin_percentage DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""total_profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""total_revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which customer segments are most profitable?,"SELECT dc.demographics, SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS profit FROM fact_sales fs JOIN dim_products dp ON fs.product_key = dp.product_key JOIN dim_customers dc ON fs.customer_key = dc.customer_key GROUP BY dc.demographics ORDER BY profit DESC;",{}
What are our best-selling products?,"SELECT
  dp.product_name,
  SUM(fs.order_quantity * dp.product_price) AS total_revenue
FROM fact_sales fs
JOIN dim_products dp ON fs.product_key = dp.product_key
GROUP BY
  dp.product_name
ORDER BY
  total_revenue DESC;","{""product_name"":{""0"":""Mountain-200 Black, 46"",""1"":""Mountain-200 Black, 42"",""2"":""Mountain-200 Silver, 38"",""3"":""Mountain-200 Silver, 46"",""4"":""Mountain-200 Black, 38""},""total_revenue"":{""0"":1241753.5092,""1"":1233557.1163999999,""2"":1213851.8855999999,""3"":1182780.5915999999,""4"":1165936.8758}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  (SUM(s.order_quantity * (p.product_price - p.product_cost)) / SUM(s.order_quantity * p.product_price)) AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_name
HAVING
  SUM(s.order_quantity * p.product_price) > 0
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, S"",""4"":""Hitch Rack - 4-Bike""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":6240.907,""4"":22686.24},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":9969.5,""4"":36240.0},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 1.0 / NULLIF(SUM(s.order_quantity * p.product_price), 0)) AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_name
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, S"",""4"":""Hitch Rack - 4-Bike""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":6240.907,""4"":22686.24},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":9969.5,""4"":36240.0},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT
  p.product_key,
  p.product_name,
  (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 100.0) / NULLIF(SUM(s.order_quantity * p.product_price), 0) AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_key,
  p.product_name
HAVING
  SUM(s.order_quantity * p.product_price) > 0
ORDER BY
  profit_margin DESC;","{""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""profit_margin"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  CASE
    WHEN SUM(s.order_quantity * p.product_price) > 0
    THEN (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 100.0) / SUM(s.order_quantity * p.product_price)
    ELSE 0
  END AS profit_margin_percentage
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_name
ORDER BY
  profit_margin_percentage DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, S"",""4"":""Hitch Rack - 4-Bike""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":6240.907,""4"":22686.24},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":9969.5,""4"":36240.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which products have the highest profit margin?,"SELECT
  p.product_key,
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  CASE
    WHEN SUM(s.order_quantity * p.product_price) = 0 THEN 0
    ELSE (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 100.0) / SUM(s.order_quantity * p.product_price)
  END AS profit_margin_percentage
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_key,
  p.product_name
ORDER BY
  profit_margin_percentage DESC;","{""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which products have the highest profit margin?,"SELECT
  dp.product_name,
  SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS profit,
  SUM(fs.order_quantity * dp.product_price) AS revenue,
  (SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) * 1.0 / NULLIF(SUM(fs.order_quantity * dp.product_price), 0)) AS profit_margin
FROM fact_sales fs
JOIN dim_products dp ON fs.product_key = dp.product_key
GROUP BY
  dp.product_name
HAVING
  SUM(fs.order_quantity * dp.product_price) > 0
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, S"",""4"":""Hitch Rack - 4-Bike""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":6240.907,""4"":22686.24},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":9969.5,""4"":36240.0},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  p.product_key,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  CASE
    WHEN SUM(s.order_quantity * p.product_price) = 0 THEN 0
    ELSE (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 1.0) / SUM(s.order_quantity * p.product_price)
  END AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_key,
  p.product_name
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT p.product_name, ((p.product_price - p.product_cost) / NULLIF(p.product_price, 0)) AS profit_margin FROM dim_products p WHERE p.product_price IS NOT NULL AND p.product_cost IS NOT NULL AND p.product_price > 0 ORDER BY profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Mountain Bike Socks, M"",""3"":""Mountain Bike Socks, L"",""4"":""Fender Set - Mountain""},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6424947368,""3"":0.6424947368,""4"":0.6260009099}}"
Which products have the highest profit margin?,"SELECT
  dp.product_key,
  dp.product_name,
  SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS total_profit,
  SUM(fs.order_quantity * dp.product_price) AS total_revenue,
  (SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) * 100.0) / NULLIF(SUM(fs.order_quantity * dp.product_price), 0) AS profit_margin_percentage
FROM fact_sales fs
JOIN dim_products dp ON fs.product_key = dp.product_key
GROUP BY
  dp.product_key,
  dp.product_name
HAVING SUM(fs.order_quantity * dp.product_price) > 0
ORDER BY
  profit_margin_percentage DESC;","{""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""total_profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""total_revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 100.0) / NULLIF(SUM(s.order_quantity * p.product_price), 0) AS profit_margin_percentage
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_key, p.product_name
ORDER BY
  profit_margin_percentage DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  p.product_price,
  p.product_cost,
  (p.product_price - p.product_cost) AS profit_per_unit,
  CASE
    WHEN p.product_price > 0 THEN (p.product_price - p.product_cost) / p.product_price
    ELSE 0
  END AS profit_margin
FROM dim_products p
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Mountain Bike Socks, M"",""3"":""Mountain Bike Socks, L"",""4"":""Fender Set - Mountain""},""product_price"":{""0"":33.6442,""1"":33.6442,""2"":9.5,""3"":9.5,""4"":21.98},""product_cost"":{""0"":12.0278,""1"":12.0278,""2"":3.3963,""3"":3.3963,""4"":8.2205},""profit_per_unit"":{""0"":21.6164,""1"":21.6164,""2"":6.1037,""3"":6.1037,""4"":13.7595},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6424947368,""3"":0.6424947368,""4"":0.6260009099}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  p.product_key,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  CASE
    WHEN SUM(s.order_quantity * p.product_price) = 0 THEN 0
    ELSE SUM(s.order_quantity * (p.product_price - p.product_cost)) / SUM(s.order_quantity * p.product_price)
  END AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_name,
  p.product_key
HAVING
  SUM(s.order_quantity * p.product_price) > 0 -- Ensure we only consider products with sales
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT p.product_name, (p.product_price - p.product_cost) AS profit_margin_per_unit FROM dim_products p ORDER BY profit_margin_per_unit DESC;","{""product_name"":{""0"":""Mountain-100 Silver, 48"",""1"":""Mountain-100 Silver, 38"",""2"":""Mountain-100 Silver, 42"",""3"":""Mountain-100 Silver, 44"",""4"":""Mountain-100 Black, 48""},""profit_margin_per_unit"":{""0"":1487.8356,""1"":1487.8356,""2"":1487.8356,""3"":1487.8356,""4"":1476.8956}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS total_profit,
  SUM(s.order_quantity * p.product_price) AS total_revenue,
  (SUM(s.order_quantity * (p.product_price - p.product_cost)) / NULLIF(SUM(s.order_quantity * p.product_price), 0)) * 100 AS profit_margin_percentage
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_key,
  p.product_name
HAVING
  SUM(s.order_quantity * p.product_price) > 0
ORDER BY
  profit_margin_percentage DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""total_profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""total_revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which products have the highest profit margin?,"SELECT
  dp.product_name,
  SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS profit,
  SUM(fs.order_quantity * dp.product_price) AS revenue,
  (SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) * 1.0 / NULLIF(SUM(fs.order_quantity * dp.product_price), 0)) AS profit_margin
FROM fact_sales fs
JOIN dim_products dp ON fs.product_key = dp.product_key
GROUP BY
  dp.product_key, dp.product_name
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT
  dp.product_key,
  dp.product_name,
  SUM(fs.order_quantity * dp.product_price) AS total_revenue,
  SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS total_profit,
  CASE
    WHEN SUM(fs.order_quantity * dp.product_price) > 0
    THEN SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) * 1.0 / SUM(fs.order_quantity * dp.product_price)
    ELSE 0
  END AS profit_margin
FROM fact_sales AS fs
JOIN dim_products AS dp
  ON fs.product_key = dp.product_key
GROUP BY
  dp.product_key,
  dp.product_name
ORDER BY
  profit_margin DESC;","{""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""total_revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""total_profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  CASE
    WHEN p.product_price > 0 THEN (p.product_price - p.product_cost) / p.product_price
    ELSE 0
  END AS profit_margin
FROM dim_products p
WHERE p.product_price IS NOT NULL AND p.product_cost IS NOT NULL
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Mountain Bike Socks, M"",""3"":""Mountain Bike Socks, L"",""4"":""Fender Set - Mountain""},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6424947368,""3"":0.6424947368,""4"":0.6260009099}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 100.0) / NULLIF(SUM(s.order_quantity * p.product_price), 0) AS profit_margin_percentage
FROM fact_sales s
JOIN dim_products p
  ON s.product_key = p.product_key
GROUP BY
  p.product_key,
  p.product_name
ORDER BY
  profit_margin_percentage DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 1.0 / NULLIF(SUM(s.order_quantity * p.product_price), 0)) AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_key,
  p.product_name
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT
  dp.product_key,
  dp.product_name,
  SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS total_profit,
  SUM(fs.order_quantity * dp.product_price) AS total_revenue,
  CASE
    WHEN SUM(fs.order_quantity * dp.product_price) > 0 THEN
      (SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) * 100.0) / SUM(fs.order_quantity * dp.product_price)
    ELSE 0
  END AS profit_margin_percentage
FROM fact_sales fs
JOIN dim_products dp
  ON fs.product_key = dp.product_key
GROUP BY
  dp.product_key,
  dp.product_name
ORDER BY
  profit_margin_percentage DESC;","{""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""total_profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""total_revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  SUM(s.order_quantity * p.product_price) AS revenue,
  CASE
    WHEN SUM(s.order_quantity * p.product_price) = 0 THEN 0
    ELSE SUM(s.order_quantity * (p.product_price - p.product_cost)) / SUM(s.order_quantity * p.product_price)
  END AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_key, p.product_name
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  ((p.product_price - p.product_cost) / p.product_price) * 100 AS profit_margin_percentage
FROM
  dim_products p
WHERE
  p.product_price > 0 -- To avoid division by zero for profit margin calculation
ORDER BY
  profit_margin_percentage DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Mountain Bike Socks, M"",""3"":""Mountain Bike Socks, L"",""4"":""Fender Set - Mountain""},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":64.2494736842,""3"":64.2494736842,""4"":62.6000909918}}"
Which products have the highest profit margin?,"SELECT
  p.product_name,
  CASE
    WHEN SUM(s.order_quantity * p.product_price) = 0 THEN NULL
    ELSE SUM(s.order_quantity * (p.product_price - p.product_cost)) * 1.0 / SUM(s.order_quantity * p.product_price)
  END AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_name
ORDER BY
  profit_margin DESC;","{""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, S"",""4"":""Hitch Rack - 4-Bike""},""profit_margin"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
