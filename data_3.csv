question,sql_query,data_preview
Which products have the highest profit margin?,"SELECT
  p.product_key,
  p.product_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS total_profit,
  SUM(s.order_quantity * p.product_price) AS total_revenue,
  (SUM(s.order_quantity * (p.product_price - p.product_cost))) * 1.0 / NULLIF(SUM(s.order_quantity * p.product_price), 0) AS profit_margin_percentage
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_key,
  p.product_name
ORDER BY
  profit_margin_percentage DESC;","{""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""total_profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""total_revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":0.6425000446,""1"":0.6425000446,""2"":0.6260009099,""3"":0.626,""4"":0.626}}"
What are our best-selling products?,"SELECT
  dp.product_name,
  SUM(fs.order_quantity * dp.product_price) AS total_revenue
FROM fact_sales AS fs
JOIN dim_products AS dp
  ON fs.product_key = dp.product_key
GROUP BY
  dp.product_name
ORDER BY
  total_revenue DESC;","{""product_name"":{""0"":""Mountain-200 Black, 46"",""1"":""Mountain-200 Black, 42"",""2"":""Mountain-200 Silver, 38"",""3"":""Mountain-200 Silver, 46"",""4"":""Mountain-200 Black, 38""},""total_revenue"":{""0"":1241753.5092,""1"":1233557.1163999999,""2"":1213851.8855999999,""3"":1182780.5915999999,""4"":1165936.8758}}"
What is the total sales for last quarter?,"WITH max_date AS (
  SELECT MAX(date) AS latest_date FROM dim_calendar
),
last_q AS (
  SELECT
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN EXTRACT(YEAR FROM latest_date) - 1
      ELSE EXTRACT(YEAR FROM latest_date)
    END AS target_year,
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN 4
      ELSE EXTRACT(QUARTER FROM latest_date) - 1
    END AS target_quarter
  FROM max_date
)
SELECT
  lq.target_year,
  lq.target_quarter,
  SUM(s.order_quantity * p.product_price) AS revenue_last_quarter
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
JOIN dim_calendar c ON s.order_date = c.date
CROSS JOIN last_q lq
WHERE c.year = lq.target_year
  AND c.quarter = lq.target_quarter
GROUP BY
  lq.target_year,
  lq.target_quarter;","{""target_year"":{""0"":2022.0},""target_quarter"":{""0"":1.0},""revenue_last_quarter"":{""0"":4062216.0833000001}}"
Which customer segments are most profitable over the last 12 months?,"WITH max_date AS (
  SELECT MAX(date) AS latest_date FROM dim_calendar
)
SELECT
  dc.demographics,
  SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS profit
FROM fact_sales fs
JOIN dim_products dp ON fs.product_key = dp.product_key
JOIN dim_customers dc ON fs.customer_key = dc.customer_key
JOIN dim_calendar dcal ON fs.order_date = dcal.date
CROSS JOIN max_date md
WHERE dcal.date >= (md.latest_date - INTERVAL '12 months')
  AND dcal.date <= md.latest_date
GROUP BY
  dc.demographics
ORDER BY
  profit DESC;",SQL_FAILED
Which customer segments are most profitable?,"SELECT dc.demographics, SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS total_profit FROM fact_sales AS fs JOIN dim_products AS dp ON fs.product_key = dp.product_key JOIN dim_customers AS dc ON fs.customer_key = dc.customer_key GROUP BY dc.demographics ORDER BY total_profit DESC;",SQL_FAILED
"What were the total revenue, profit, and average profit margin for the company in the last completed quarter?","WITH max_date AS (
  SELECT MAX(date) AS latest_date FROM dim_calendar
),
last_q AS (
  SELECT
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN EXTRACT(YEAR FROM latest_date) - 1
      ELSE EXTRACT(YEAR FROM latest_date)
    END AS target_year,
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN 4
      ELSE EXTRACT(QUARTER FROM latest_date) - 1
    END AS target_quarter
  FROM max_date
)
SELECT
  lq.target_year,
  lq.target_quarter,
  SUM(s.order_quantity * p.product_price) AS total_revenue,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS total_profit,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) / NULLIF(SUM(s.order_quantity * p.product_price), 0) AS average_profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
JOIN dim_calendar c ON s.order_date = c.date
CROSS JOIN last_q lq
WHERE c.year = lq.target_year
  AND c.quarter = lq.target_quarter
GROUP BY
  lq.target_year,
  lq.target_quarter;","{""target_year"":{""0"":2022.0},""target_quarter"":{""0"":1.0},""total_revenue"":{""0"":4062216.0833000001},""total_profit"":{""0"":1722870.7890000001},""average_profit_margin"":{""0"":0.4241209118}}"
"How have quarterly revenue and profit trended over the past two years, showing year-over-year and quarter-over-quarter growth rates?","WITH max_year_cte AS (
    SELECT MAX(year) AS max_sales_year
    FROM dim_calendar
),
quarterly_data AS (
    SELECT
        c.year,
        c.quarter,
        SUM(s.order_quantity * p.product_price) AS quarterly_revenue,
        SUM(s.order_quantity * (p.product_price - p.product_cost)) AS quarterly_profit
    FROM fact_sales s
    JOIN dim_products p ON s.product_key = p.product_key
    JOIN dim_calendar c ON s.order_date = c.date
    CROSS JOIN max_year_cte my
    WHERE c.year >= my.max_sales_year - 1
      AND c.year <= my.max_sales_year
    GROUP BY
        c.year,
        c.quarter
),
lagged_data AS (
    SELECT
        year,
        quarter,
        quarterly_revenue,
        quarterly_profit,
        LAG(quarterly_revenue, 1) OVER (ORDER BY year, quarter) AS prev_quarter_revenue,
        LAG(quarterly_profit, 1) OVER (ORDER BY year, quarter) AS prev_quarter_profit,
        LAG(quarterly_revenue, 4) OVER (PARTITION BY quarter ORDER BY year) AS prev_year_revenue,
        LAG(quarterly_profit, 4) OVER (PARTITION BY quarter ORDER BY year) AS prev_year_profit
    FROM quarterly_data
)
SELECT
    year,
    quarter,
    quarterly_revenue,
    quarterly_profit,
    (quarterly_revenue - prev_quarter_revenue) * 100.0 / NULLIF(prev_quarter_revenue, 0) AS qoq_revenue_growth_rate,
    (quarterly_profit - prev_quarter_profit) * 100.0 / NULLIF(prev_quarter_profit, 0) AS qoq_profit_growth_rate,
    (quarterly_revenue - prev_year_revenue) * 100.0 / NULLIF(prev_year_revenue, 0) AS yoy_revenue_growth_rate,
    (quarterly_profit - prev_year_profit) * 100.0 / NULLIF(prev_year_profit, 0) AS yoy_profit_growth_rate
FROM lagged_data
ORDER BY
    year,
    quarter;","{""year"":{""0"":2021,""1"":2021,""2"":2021,""3"":2021,""4"":2022},""quarter"":{""0"":1,""1"":2,""2"":3,""3"":4,""4"":1},""quarterly_revenue"":{""0"":1378550.4021000001,""1"":1574317.1436000001,""2"":2572293.3480000002,""3"":3799042.898,""4"":4062216.0833000001},""quarterly_profit"":{""0"":581699.7936,""1"":670279.8104,""2"":1101311.9005,""3"":1613792.6225000001,""4"":1722870.7890000001},""qoq_revenue_growth_rate"":{""0"":null,""1"":14.2009128721,""2"":63.3910523338,""3"":47.6908884033,""4"":6.9273549251},""qoq_profit_growth_rate"":{""0"":null,""1"":15.2277889342,""2"":64.3062917027,""3"":46.5336587907,""4"":6.7591191693},""yoy_revenue_growth_rate"":{""0"":null,""1"":null,""2"":null,""3"":null,""4"":null},""yoy_profit_growth_rate"":{""0"":null,""1"":null,""2"":null,""3"":null,""4"":null}}"
"Which product categories and subcategories are the top 5 contributors to overall profit, and what is their individual profit margin?","SELECT
  pc.category_name,
  psc.subcategory_name,
  SUM(s.order_quantity * (p.product_price - p.product_cost)) AS profit,
  (SUM(s.order_quantity * (p.product_price - p.product_cost)) * 100.0) / SUM(s.order_quantity * p.product_price) AS profit_margin
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
JOIN dim_product_subcategories psc ON p.product_subcategory_key = psc.product_subcategory_key
JOIN dim_product_categories pc ON psc.product_category_key = pc.product_category_key
GROUP BY
  pc.category_name,
  psc.subcategory_name
ORDER BY
  profit DESC
LIMIT 5;","{""category_name"":{""0"":""Bikes"",""1"":""Bikes"",""2"":""Bikes"",""3"":""Accessories"",""4"":""Accessories""},""subcategory_name"":{""0"":""Road Bikes"",""1"":""Mountain Bikes"",""2"":""Touring Bikes"",""3"":""Tires and Tubes"",""4"":""Helmets""},""profit"":{""0"":4368346.6524,""1"":3930661.5723000001,""2"":1427160.0464999999,""3"":238396.3948,""4"":131036.4003},""profit_margin"":{""0"":38.7018335235,""1"":45.7919045022,""2"":37.8399994473,""3"":62.5997093481,""4"":63.6612223474}}"
"Which sales regions and countries are driving the highest revenue and profit, and what are their respective profit margins compared to the company average?","WITH region_country_summary AS (
    SELECT
        dt.region,
        dt.country,
        SUM(fs.order_quantity * dp.product_price) AS region_country_revenue,
        SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS region_country_profit
    FROM
        fact_sales fs
    JOIN
        dim_products dp ON fs.product_key = dp.product_key
    JOIN
        dim_territories dt ON fs.territory_key = dt.sales_territory_key
    GROUP BY
        dt.region,
        dt.country
),
company_wide_summary AS (
    SELECT
        SUM(fs.order_quantity * dp.product_price) AS total_revenue,
        SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS total_profit
    FROM
        fact_sales fs
    JOIN
        dim_products dp ON fs.product_key = dp.product_key
)
SELECT
    rcs.region,
    rcs.country,
    rcs.region_country_revenue,
    rcs.region_country_profit,
    CASE
        WHEN rcs.region_country_revenue = 0 THEN 0
        ELSE rcs.region_country_profit / rcs.region_country_revenue
    END AS region_country_profit_margin,
    CASE
        WHEN cws.total_revenue = 0 THEN 0
        ELSE cws.total_profit / cws.total_revenue
    END AS company_average_profit_margin
FROM
    region_country_summary rcs
CROSS JOIN
    company_wide_summary cws
ORDER BY
    rcs.region_country_revenue DESC,
    rcs.region_country_profit DESC;","{""region"":{""0"":""Australia"",""1"":""Southwest"",""2"":""Northwest"",""3"":""United Kingdom"",""4"":""Germany""},""country"":{""0"":""Australia"",""1"":""United States"",""2"":""United States"",""3"":""United Kingdom"",""4"":""Germany""},""region_country_revenue"":{""0"":7416456.2001,""1"":4822794.7006000001,""2"":3095074.4725000001,""3"":2902562.0948999999,""4"":2524679.9728000001},""region_country_profit"":{""0"":3077022.8102000002,""1"":2040345.1710999999,""2"":1314751.2681,""3"":1214774.4158000001,""4"":1054186.2072000001},""region_country_profit_margin"":{""0"":0.4148912536,""1"":0.4230628293,""2"":0.4247882498,""3"":0.4185179769,""4"":0.41755241},""company_average_profit_margin"":{""0"":0.4197426797,""1"":0.4197426797,""2"":0.4197426797,""3"":0.4197426797,""4"":0.4197426797}}"
"What is the overall product return rate, and which product categories exhibit the highest return rates, indicating potential quality or customer satisfaction issues?","WITH product_sales AS (
  SELECT
    pc.category_name,
    SUM(fs.order_quantity) AS total_ordered_quantity
  FROM fact_sales fs
  JOIN dim_products dp ON fs.product_key = dp.product_key
  JOIN dim_product_subcategories dps ON dp.product_subcategory_key = dps.product_subcategory_key
  JOIN dim_product_categories pc ON dps.product_category_key = pc.product_category_key
  GROUP BY
    pc.category_name
),
product_returns AS (
  SELECT
    pc.category_name,
    SUM(fr.return_quantity) AS total_returned_quantity
  FROM fact_returns fr
  JOIN dim_products dp ON fr.product_key = dp.product_key
  JOIN dim_product_subcategories dps ON dp.product_subcategory_key = dps.product_subcategory_key
  JOIN dim_product_categories pc ON dps.product_category_key = pc.product_category_key
  GROUP BY
    pc.category_name
)
SELECT
  ps.category_name,
  ps.total_ordered_quantity,
  COALESCE(pr.total_returned_quantity, 0) AS total_returned_quantity,
  (CAST(COALESCE(pr.total_returned_quantity, 0) AS DECIMAL) / ps.total_ordered_quantity) AS return_rate
FROM product_sales ps
LEFT JOIN product_returns pr ON ps.category_name = pr.category_name
WHERE ps.total_ordered_quantity > 0
ORDER BY
  return_rate DESC;","{""category_name"":{""0"":""Bikes"",""1"":""Clothing"",""2"":""Accessories""},""total_ordered_quantity"":{""0"":13929,""1"":12436,""2"":57809},""total_returned_quantity"":{""0"":429,""1"":269,""2"":1130},""return_rate"":{""0"":0.0307990523,""1"":0.0216307494,""2"":0.0195471293}}"
Which products have the highest profit margin?,"SELECT
  dp.product_key,
  dp.product_name,
  SUM(fs.order_quantity * (dp.product_price - dp.product_cost)) AS total_profit,
  SUM(fs.order_quantity * dp.product_price) AS total_revenue,
  CASE
    WHEN SUM(fs.order_quantity * dp.product_price) = 0 THEN 0
    ELSE (SUM(fs.order_quantity * (dp.product_price - dp.product_cost))::numeric / SUM(fs.order_quantity * dp.product_price)) * 100
  END AS profit_margin_percentage
FROM fact_sales AS fs
JOIN dim_products AS dp
  ON fs.product_key = dp.product_key
GROUP BY
  dp.product_key,
  dp.product_name
ORDER BY
  profit_margin_percentage DESC;","{""product_key"":{""0"":215,""1"":220,""2"":485,""3"":472,""4"":486},""product_name"":{""0"":""Sport-100 Helmet, Black"",""1"":""Sport-100 Helmet, Blue"",""2"":""Fender Set - Mountain"",""3"":""Classic Vest, M"",""4"":""All-Purpose Bike Stand""},""total_profit"":{""0"":41935.816,""1"":43124.718,""2"":54487.62,""3"":7234.682,""4"":23290.956},""total_revenue"":{""0"":65269.748,""1"":67120.179,""2"":87040.8,""3"":11557.0,""4"":37206.0},""profit_margin_percentage"":{""0"":64.2500044584,""1"":64.2500044584,""2"":62.6000909918,""3"":62.6,""4"":62.6}}"
What are our best-selling products?,"SELECT
  p.product_name,
  SUM(s.order_quantity * p.product_price) AS total_revenue
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
GROUP BY
  p.product_name
ORDER BY
  total_revenue DESC;","{""product_name"":{""0"":""Mountain-200 Black, 46"",""1"":""Mountain-200 Black, 42"",""2"":""Mountain-200 Silver, 38"",""3"":""Mountain-200 Silver, 46"",""4"":""Mountain-200 Black, 38""},""total_revenue"":{""0"":1241753.5092,""1"":1233557.1163999999,""2"":1213851.8855999999,""3"":1182780.5915999999,""4"":1165936.8758}}"
What is the total sales for last quarter?,"WITH max_date AS (
  SELECT MAX(date) AS latest_date FROM dim_calendar
),
last_q AS (
  SELECT
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN EXTRACT(YEAR FROM latest_date) - 1
      ELSE EXTRACT(YEAR FROM latest_date)
    END AS target_year,
    CASE 
      WHEN EXTRACT(QUARTER FROM latest_date) = 1
        THEN 4
      ELSE EXTRACT(QUARTER FROM latest_date) - 1
    END AS target_quarter
  FROM max_date
)
SELECT
  lq.target_year,
  lq.target_quarter,
  SUM(s.order_quantity * p.product_price) AS revenue_last_quarter
FROM fact_sales s
JOIN dim_products p ON s.product_key = p.product_key
JOIN dim_calendar c ON s.order_date = c.date
CROSS JOIN last_q lq
WHERE c.year = lq.target_year
  AND c.quarter = lq.target_quarter
GROUP BY
  lq.target_year,
  lq.target_quarter;","{""target_year"":{""0"":2022.0},""target_quarter"":{""0"":1.0},""revenue_last_quarter"":{""0"":4062216.0833000001}}"
